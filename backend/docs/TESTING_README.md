# SmartCook AI - P0 AI 功能测试文档

## 概述

本测试套件用于验证 SmartCook AI 的 P0 级 AI 食谱生成功能。包含功能完整性测试、性能测试和端到端场景测试。

## 测试文件

### 1. test_ai_generation.py - AI 功能完整性测试
**测试内容**:
- ✅ 基础生成测试 (单一食材、多种食材)
- ✅ 筛选条件测试 (菜系、口味、场景、技能、组合)
- ✅ 食材状态标注测试 ([已有]/[需补充])
- ✅ 创意菜名测试
- ✅ 合理性测试 (正常组合、边界组合)
- ✅ 数据库持久化验证

**运行方式**:
```bash
cd backend
python test_ai_generation.py
```

### 2. test_performance.py - 性能测试
**测试内容**:
- ⏱️  响应时间测试 (目标: < 15秒)
- 📊 不同食材数量的性能对比
- 🔍 筛选条件对性能的影响
- 🔄 并发请求测试 (简单版)

**运行方式**:
```bash
cd backend
python test_performance.py
```

### 3. test_e2e.py - 端到端测试
**测试场景**:
- 🎯 场景1: 新手用户快速做饭
- 🎯 场景2: 家庭主妇营养搭配
- 🎯 场景3: 剩余食材处理

**运行方式**:
```bash
cd backend
python test_e2e.py
```

### 4. run_all_tests.py - 主测试运行器
**功能**: 一键运行所有测试套件

**运行方式**:
```bash
cd backend
python run_all_tests.py
```

## 前置条件

### 1. 环境配置
确保已完成以下配置:

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置环境变量
cp .env.example .env

# 3. 编辑 .env 文件，添加 API Key
DASHSCOPE_API_KEY=your_api_key_here
```

### 2. 数据库初始化
```bash
# 初始化数据库 (如果还没有)
python init_db.py
```

### 3. 验证配置
```bash
# 测试 API 连接
python -c "from config import Config; Config.validate(); print('✅ 配置正确')"
```

## 快速开始

### 方式1: 运行所有测试 (推荐)
```bash
cd backend
python run_all_tests.py
```

### 方式2: 单独运行测试
```bash
# AI 功能测试
python test_ai_generation.py

# 性能测试
python test_performance.py

# 端到端测试
python test_e2e.py
```

## 测试结果解读

### 成功标准

#### 功能完整性
- ✅ AI 能够根据食材生成 3 个创意食谱
- ✅ 食材状态标注准确 ([已有]/[需补充])
- ✅ 筛选条件正常工作
- ✅ 创意菜名符合要求
- ✅ 合理性校验有效

#### 性能指标
- ✅ 完整生成时间 < 15秒
- ✅ 支持并发请求
- ✅ 不同食材数量性能稳定

#### 用户体验
- ✅ 生成的食谱可执行
- ✅ 步骤清晰易懂
- ✅ 食材用量合理
- ✅ 菜名有吸引力

### 输出示例

```
==============================================================
  SmartCook AI - AI 食谱生成专项测试
==============================================================
✅ 配置验证通过
   API Key: sk-abc123...
   Model: qwen-turbo

==============================================================
  测试1: 基础生成测试
==============================================================

测试1.1: 单一食材生成 (鸡蛋)
✅ 单一食材生成: 通过
   ℹ️  生成了 3 个食谱，耗时 8.45秒
✅ 食谱1结构验证: 通过
   📝 菜名: 黄金满屋蛋炒饭
   🔧 难度: 新手
   ⏱️  时间: 15分钟

...

==============================================================
  测试总结
==============================================================
总测试数: 18
✅ 通过: 17
❌ 失败: 1

通过率: 94.4%

🎉 测试结果: 优秀
```

## 常见问题

### Q1: API Key 错误
**错误**: `DASHSCOPE_API_KEY 未设置`

**解决**:
```bash
# 1. 检查 .env 文件是否存在
ls -la .env

# 2. 确认 API Key 已设置
cat .env | grep DASHSCOPE_API_KEY

# 3. 获取 API Key
# 访问: https://dashscope.console.aliyun.com/
```

### Q2: 测试超时
**错误**: 测试运行时间过长

**解决**:
- 检查网络连接
- 验证 API 服务状态
- 考虑使用更快的模型 (qwen-turbo)

### Q3: JSON 解析失败
**错误**: `JSON 解析失败`

**解决**:
- 查看日志中的原始响应
- 检查 AI 模型输出格式
- 可能需要优化 Prompt

### Q4: 数据库错误
**错误**: `数据库操作失败`

**解决**:
```bash
# 重新初始化数据库
rm smartcook.db
python init_db.py
```

## 性能优化建议

### 1. 响应时间优化
- 使用更快的模型 (qwen-turbo)
- 减少 max_tokens 设置
- 优化 Prompt 长度

### 2. 并发性能优化
- 实现请求队列
- 添加缓存机制
- 使用异步处理

### 3. 成本优化
- 缓存常见食材组合的结果
- 实现智能重试机制
- 监控 API 调用量

## 日志说明

### 日志级别
- `INFO`: 正常操作信息
- `DEBUG`: 详细调试信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 日志位置
- 控制台输出: 实时显示
- 日志文件: `logs/` 目录 (如果配置)

### 查看日志
```bash
# 查看最近的日志
tail -f logs/smartcook.log

# 搜索错误
grep "ERROR" logs/smartcook.log
```

## 下一步

### P0 完成后
1. ✅ 所有测试通过
2. ✅ 性能达标
3. ✅ 用户体验良好

### P1 优化方向
- 添加 AI 生成结果缓存
- 实现智能食材替代
- 添加营养分析功能
- 优化 Prompt 质量
- 实现用户反馈机制

## 技术支持

### 相关文档
- `CLAUDE.md` - 项目总体说明
- `DATABASE_QUICK_REFERENCE.md` - 数据库操作指南
- `IMPLEMENTATION_REPORT.md` - 实现细节

### 问题反馈
如遇到问题，请提供:
1. 错误信息和堆栈跟踪
2. 测试运行日志
3. 环境配置信息
4. 复现步骤

## 许可证

本测试套件是 SmartCook AI 项目的一部分。
